# Cilium Network Policy - Allow Essential Egress Only
# Use with default-deny to create a whitelist approach
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-essential-egress
  labels:
    app.kubernetes.io/name: qualys-network-security
    policy-type: allowlist
spec:
  description: "Allow only essential outbound connectivity"
  endpointSelector:
    matchLabels:
      security: restricted
  egress:
  # Allow DNS
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s-app: kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP

  # Allow HTTPS to specific domains
  - toFQDNs:
    - matchName: "api.example.com"
    - matchPattern: "*.googleapis.com"
    - matchPattern: "*.amazonaws.com"
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP

  # Allow internal cluster communication
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: default

  # Allow Kubernetes API
  - toEntities:
    - kube-apiserver
    toPorts:
    - ports:
      - port: "6443"
        protocol: TCP
---
# Allow specific service mesh traffic
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-service-mesh
  labels:
    app.kubernetes.io/name: qualys-network-security
spec:
  description: "Allow service mesh communication"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/part-of: service-mesh
  egress:
  - toEndpoints:
    - matchLabels:
        app.kubernetes.io/part-of: service-mesh
