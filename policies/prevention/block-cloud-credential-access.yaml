# Block Cloud Credentials Access via Network Utilities
# Generated from Qualys CDR Events - US2 Platform
#
# MITRE ATT&CK:
#   - T1552.005: Cloud Instance Metadata API
#   - T1552: Unsecured Credentials
#
# Detected Attack Pattern:
#   - Container: container-escape-using-runtime-socket-t1611
#   - Process: /usr/bin/curl accessing cloud metadata
#   - Severity: HIGH
#
# This policy blocks network utilities (curl, wget, etc) from accessing
# cloud metadata endpoints (169.254.169.254, metadata.google.internal, etc)
---
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: block-cloud-credential-access
  labels:
    generated-by: qualys-cdr
    qualys.com/platform: US2
    mitre.attack/technique: T1552.005
    mitre.attack/tactic: credential-access
    policy.qualys.com/priority: critical
    policy.qualys.com/action: block
  annotations:
    description: "Block network utilities from accessing cloud metadata/IMDS endpoints"
    qualys.com/threat-category: "Cloud_Credentials_Accessed_By_Network_Utility"
    qualys.com/cdr-event-count: "98"
spec:
  # Kprobe: Block connect() to cloud metadata IPs
  kprobes:
    # Block connections to AWS/Azure/GCP metadata endpoints
    - call: "sys_connect"
      syscall: true
      args:
        - index: 0
          type: "int"
        - index: 1
          type: "sockaddr"
      selectors:
        # AWS IMDS endpoint
        - matchArgs:
            - index: 1
              operator: "SAddr"
              values:
                - "169.254.169.254"
          matchBinaries:
            - operator: "In"
              values:
                - "/usr/bin/curl"
                - "/usr/bin/wget"
                - "/usr/bin/fetch"
                - "/usr/bin/httpie"
                - "/usr/bin/http"
          matchActions:
            - action: "Sigkill"
        # GCP metadata endpoint
        - matchArgs:
            - index: 1
              operator: "SAddr"
              values:
                - "169.254.169.254"
                - "metadata.google.internal"
          matchBinaries:
            - operator: "In"
              values:
                - "/usr/bin/curl"
                - "/usr/bin/wget"
          matchActions:
            - action: "Sigkill"

    # Block execution of network utilities with metadata URLs in args
    - call: "sys_execve"
      syscall: true
      args:
        - index: 0
          type: "string"
        - index: 1
          type: "string"
      selectors:
        # Block curl/wget with metadata endpoint in arguments
        - matchArgs:
            - index: 0
              operator: "Postfix"
              values:
                - "/curl"
                - "/wget"
            - index: 1
              operator: "Contains"
              values:
                - "169.254.169.254"
                - "metadata.google.internal"
                - "metadata.azure.com"
          matchActions:
            - action: "Sigkill"
---
# Alternative: Audit-only version for initial deployment
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: audit-cloud-credential-access
  labels:
    generated-by: qualys-cdr
    qualys.com/platform: US2
    mitre.attack/technique: T1552.005
    policy.qualys.com/priority: critical
    policy.qualys.com/action: audit
spec:
  kprobes:
    - call: "sys_connect"
      syscall: true
      args:
        - index: 0
          type: "int"
        - index: 1
          type: "sockaddr"
      selectors:
        - matchArgs:
            - index: 1
              operator: "SAddr"
              values:
                - "169.254.169.254"
          matchBinaries:
            - operator: "In"
              values:
                - "/usr/bin/curl"
                - "/usr/bin/wget"
                - "/usr/bin/fetch"
          matchActions:
            - action: "Post"
