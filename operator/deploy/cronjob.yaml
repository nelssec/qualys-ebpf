# Qualys CDR Policy Generator - Kubernetes CronJob
#
# Runs periodically to fetch CDR events and generate/update TracingPolicies.
#
# Prerequisites:
#   1. Create qualys-credentials secret (see secret.yaml.example)
#   2. Build and push the operator image
#   3. Apply this CronJob
#
# The job will:
#   1. Authenticate to Qualys API
#   2. Fetch CDR events from the last 24 hours
#   3. Generate TracingPolicies for detected threats
#   4. Apply policies to the cluster (if --apply flag is set)
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: qualys-policy-generator
  namespace: qualys-system
  labels:
    app: qualys-policy-generator
spec:
  # Run every hour
  schedule: "0 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: qualys-policy-generator
          restartPolicy: OnFailure
          containers:
            - name: policy-generator
              image: qualys/policy-operator:latest
              imagePullPolicy: Always
              args:
                - --once
                - --hours=24
                - --action=Post  # Change to Sigkill for blocking
                - --apply
                - --output=/policies
              env:
                - name: QUALYS_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: qualys-credentials
                      key: username
                - name: QUALYS_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: qualys-credentials
                      key: password
                - name: QUALYS_GATEWAY_URL
                  valueFrom:
                    configMapKeyRef:
                      name: qualys-config
                      key: QUALYS_GATEWAY_URL
                      optional: true
                - name: QUALYS_PLATFORM
                  valueFrom:
                    configMapKeyRef:
                      name: qualys-config
                      key: QUALYS_PLATFORM
                      optional: true
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "100m"
                limits:
                  memory: "256Mi"
                  cpu: "500m"
              volumeMounts:
                - name: policies
                  mountPath: /policies
          volumes:
            - name: policies
              emptyDir: {}
---
# ServiceAccount with permissions to create TracingPolicies
apiVersion: v1
kind: ServiceAccount
metadata:
  name: qualys-policy-generator
  namespace: qualys-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: qualys-policy-generator
rules:
  # TracingPolicy management
  - apiGroups: ["cilium.io"]
    resources: ["tracingpolicies"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # For status updates
  - apiGroups: ["cilium.io"]
    resources: ["tracingpolicies/status"]
    verbs: ["get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: qualys-policy-generator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: qualys-policy-generator
subjects:
  - kind: ServiceAccount
    name: qualys-policy-generator
    namespace: qualys-system
